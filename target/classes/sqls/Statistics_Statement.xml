<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dowon.bds.model.mapper.StatisticsDaoImpl">

<select id="imgSelect" resultType="GenderDto">
SELECT B.BOOK_IMG
FROM (
  		SELECT R.BOOK_SEQ
  		FROM TB_BOOK_RENT R
  		GROUP BY R.BOOK_SEQ
  		ORDER BY COUNT(*) DESC
  		FETCH FIRST 5 ROWS ONLY
		) Top1Books
JOIN TB_BOOK B ON Top1Books.BOOK_SEQ = B.BOOK_SEQ
</select>

<select id="genderStatistics" resultType="GenderDto">
WITH Top1Books AS (
  SELECT BOOK_SEQ , COUNT(*) AS loan_count
  FROM TB_BOOK_RENT tbr
  GROUP BY BOOK_SEQ 
  ORDER BY loan_count DESC
  FETCH FIRST 1 ROWS ONLY
),
GenderTest AS(
SELECT
  T1B.BOOK_SEQ,
  B.BOOK_TITLE,
  B.BOOK_IMG,
  U.USER_GENDER,
  COUNT(*) AS loan_count
FROM
  Top1Books T1B
  JOIN TB_BOOK_RENT R ON T1B.BOOK_SEQ = R.BOOK_SEQ
  JOIN TB_USER U ON R.USER_SEQ = U.USER_SEQ
  JOIN TB_BOOK B ON T1B.BOOK_SEQ = B.BOOK_SEQ
GROUP BY
  T1B.BOOK_SEQ,
  B.BOOK_TITLE,
  B.BOOK_IMG,
  U.USER_GENDER
)  
SELECT 
	GT.BOOK_SEQ,
	GT.BOOK_IMG,
	GT.BOOK_TITLE,
	GT.USER_GENDER,
	TO_CHAR((GT.loan_count / SUM(GT.loan_count) OVER (PARTITION BY GT.BOOK_SEQ)) * 100, 'FM99990') || '%' AS PERCENT
FROM GenderTest GT	
ORDER BY
  GT.BOOK_SEQ,
  GT.USER_GENDER

</select>

<select id="AgeStatistics" resultType="AgeDto">
WITH Top1Books AS (
  SELECT BOOK_SEQ, COUNT(*) AS loan_count
  FROM TB_BOOK_RENT
  GROUP BY BOOK_SEQ 
  ORDER BY loan_count DESC
  FETCH FIRST 1 ROWS ONLY
)
SELECT
  T1B.BOOK_SEQ,
  B.BOOK_TITLE,
  CASE 
    WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 19 AND EXTRACT(YEAR FROM SYSDATE) - 10 THEN '10대'
    WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 29 AND EXTRACT(YEAR FROM SYSDATE) - 20 THEN '20대'
    WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 39 AND EXTRACT(YEAR FROM SYSDATE) - 30 THEN '30대'
    WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 49 AND EXTRACT(YEAR FROM SYSDATE) - 40 THEN '40대'
    ELSE '50대 이상'
  END AS age_group,
  TO_CHAR(
    (COUNT(*) / SUM(COUNT(*)) OVER (PARTITION BY T1B.BOOK_SEQ)) * 100, 'FM99990') || '%' AS percent
FROM
  Top1Books T1B
  JOIN TB_BOOK_RENT R ON T1B.BOOK_SEQ = R.BOOK_SEQ
  JOIN TB_USER U ON R.USER_SEQ = U.USER_SEQ
  JOIN TB_BOOK B ON T1B.BOOK_SEQ = B.BOOK_SEQ
GROUP BY
  T1B.BOOK_SEQ,
  B.BOOK_TITLE,
  CASE 
    WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 19 AND EXTRACT(YEAR FROM SYSDATE) - 10 THEN '10대'
    WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 29 AND EXTRACT(YEAR FROM SYSDATE) - 20 THEN '20대'
    WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 39 AND EXTRACT(YEAR FROM SYSDATE) - 30 THEN '30대'
    WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 49 AND EXTRACT(YEAR FROM SYSDATE) - 40 THEN '40대'
    ELSE '50대 이상'
  END
ORDER BY
  T1B.BOOK_SEQ,
  age_group
</select>

<select id="bookSearch" resultType="BookDto" parameterType="Integer">
SELECT BOOK_TITLE,BOOK_SEQ,BOOK_INTRO
	FROM TB_BOOK
	WHERE BOOK_SEQ = #{book_seq}
</select>

<select id="detailGenderStatistics" resultType="GenderDto">
WITH GenderStats AS (
  SELECT
    B.BOOK_SEQ,
    B.BOOK_TITLE,
    B.BOOK_IMG,
    U.USER_GENDER,
    COUNT(*) AS loan_count
  FROM
    TB_BOOK_RENT R
    JOIN TB_USER U ON R.USER_SEQ = U.USER_SEQ
    JOIN TB_BOOK B ON R.BOOK_SEQ = B.BOOK_SEQ
  WHERE
    B.BOOK_SEQ = #{book_seq}
  GROUP BY
    B.BOOK_SEQ,
    B.BOOK_TITLE,
    B.BOOK_IMG,
    U.USER_GENDER
)
SELECT 
  GS.BOOK_SEQ,
  GS.BOOK_IMG,
  GS.BOOK_TITLE,
  GS.USER_GENDER,
  TO_CHAR((GS.loan_count / SUM(GS.loan_count) OVER (PARTITION BY GS.BOOK_SEQ)) * 100, 'FM99990') || '%' AS PERCENT
FROM GenderStats GS
ORDER BY
  GS.USER_GENDER
</select>


<select id="detailAgeStatistics" resultType="AgeDto">
WITH AgeStats AS (
  SELECT
    B.BOOK_SEQ,
    B.BOOK_TITLE,
    CASE 
      WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 19 AND EXTRACT(YEAR FROM SYSDATE) - 10 THEN '10대'
      WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 29 AND EXTRACT(YEAR FROM SYSDATE) - 20 THEN '20대'
      WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 39 AND EXTRACT(YEAR FROM SYSDATE) - 30 THEN '30대'
      WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 49 AND EXTRACT(YEAR FROM SYSDATE) - 40 THEN '40대'
      ELSE '50대 이상'
    END AS age_group,
    TO_CHAR(
      (COUNT(*) / SUM(COUNT(*)) OVER (PARTITION BY B.BOOK_SEQ)) * 100, 'FM99990') || '%' AS percent
  FROM
    TB_BOOK_RENT R
    JOIN TB_USER U ON R.USER_SEQ = U.USER_SEQ
    JOIN TB_BOOK B ON R.BOOK_SEQ = B.BOOK_SEQ
  WHERE
    B.BOOK_SEQ = #{book_seq}
  GROUP BY
    B.BOOK_SEQ,
    B.BOOK_TITLE,
    CASE 
      WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 19 AND EXTRACT(YEAR FROM SYSDATE) - 10 THEN '10대'
      WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 29 AND EXTRACT(YEAR FROM SYSDATE) - 20 THEN '20대'
      WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 39 AND EXTRACT(YEAR FROM SYSDATE) - 30 THEN '30대'
      WHEN TO_NUMBER(SUBSTR(U.USER_BIRTH, 1, 4)) BETWEEN EXTRACT(YEAR FROM SYSDATE) - 49 AND EXTRACT(YEAR FROM SYSDATE) - 40 THEN '40대'
      ELSE '50대 이상'
    END
)
SELECT 
  Ages.BOOK_SEQ,
  Ages.BOOK_TITLE,
  Ages.age_group,
  Ages.percent
FROM AgeStats Ages
ORDER BY
  Ages.age_group
</select>

</mapper>
